<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TINTIN - Editar Perfil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            margin-bottom: 20px;
            position: relative;
        }

        .user-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .type-option {
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .type-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .type-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15, #764ba215);
        }

        .type-option.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .type-option .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .type-option h3 {
            margin-bottom: 5px;
            color: #333;
        }

        .type-option p {
            font-size: 14px;
            color: #666;
        }

        .type-note {
            margin-top: 8px;
            text-align: center;
            font-size: 13px;
            color: #666;
            display: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 25px 0 15px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
        }

        .add-item-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            margin-top: 20px;
        }

        .btn-primary:hover:enabled {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35);
        }

        .btn-primary:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #667eea;
            color: white;
            padding: 12px 22px;
        }

        .btn-secondary:hover {
            opacity: 0.9;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #ecfdf5;
            color: #047857;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            text-align: center;
        }

        .success-message.show {
            display: block;
        }

        .interest-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            background: #fafbff;
        }

        .interest-card .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }

        .loading-state {
            text-align: center;
            padding: 40px 0;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102,126,234,0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 640px) {
            .card {
                padding: 28px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="page-title">üéì Complete seu Perfil</h1>
            <p id="page-subtitle">Conte mais sobre voc√™ para receber matches melhores</p>
        </div>

        <div class="card">
            <div id="loading-state" class="loading-state">
                <div class="spinner"></div>
                <p>Carregando informa√ß√µes do seu perfil...</p>
            </div>

            <div id="form-content" style="display: none;">
                <div class="user-type-selector">
                    <div class="type-option" id="student-option" onclick="selectUserType('student')">
                        <div class="icon">üìö</div>
                        <h3>Quero Aprender</h3>
                        <p>Encontre professores para te ajudar</p>
                    </div>
                    <div class="type-option" id="teacher-option" onclick="selectUserType('teacher')">
                        <div class="icon">üë®‚Äçüè´</div>
                        <h3>Quero Ensinar</h3>
                        <p>Compartilhe seu conhecimento</p>
                    </div>
                </div>
                <p class="type-note" id="type-note">Caso deseje alterar o tipo da sua conta, fale com o suporte para avaliarmos juntos.</p>

                <div class="section-title">Informa√ß√µes gerais</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name-input">Nome</label>
                        <input type="text" id="name-input" placeholder="Seu nome completo">
                    </div>
                    <div class="form-group">
                        <label for="location-input">Localiza√ß√£o</label>
                        <input type="text" id="location-input" placeholder="Cidade, Estado">
                    </div>
                    <div class="form-group">
                        <label for="languages-input">Idiomas</label>
                        <input type="text" id="languages-input" placeholder="Ex: Portugu√™s, Ingl√™s">
                    </div>
                    <div class="form-group">
                        <label for="availability-input">Disponibilidade</label>
                        <input type="text" id="availability-input" placeholder="Ex: Noites durante a semana">
                    </div>
                    <div class="form-group">
                        <label for="price-input">Valor por hora (opcional)</label>
                        <input type="number" step="0.01" id="price-input" placeholder="Ex: 60.00">
                    </div>
                    <div class="form-group">
                        <label for="credentials-input">Forma√ß√£o & Certifica√ß√µes</label>
                        <input type="text" id="credentials-input" placeholder="Ex: Licenciatura em Matem√°tica">
                    </div>
                    <div class="form-group full-width">
                        <label for="bio-input">Sobre voc√™</label>
                        <textarea id="bio-input" rows="4" placeholder="Conte um pouco sobre sua experi√™ncia, hobbies ou objetivos."></textarea>
                    </div>
                </div>

                <div id="global-error" class="error-message"></div>
                <div id="save-feedback" class="success-message"></div>

                <form id="student-form" class="form-section">
                    <h2 class="section-title">O que voc√™ quer aprender?</h2>

                    <div class="add-item-group">
                        <div style="display: grid; gap: 10px;">
                            <input type="text" id="interest-name" placeholder="Ex: Python, Trocar Chuveiro, Viol√£o...">
                            <select id="interest-difficulty">
                                <option value="beginner">Iniciante</option>
                                <option value="intermediate">Intermedi√°rio</option>
                                <option value="advanced">Avan√ßado</option>
                            </select>
                            <textarea id="interest-description" placeholder="Descreva o que voc√™ quer aprender (opcional)" rows="2"></textarea>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addInterest()">Adicionar</button>
                    </div>

                    <div id="interests-container" style="margin-top: 20px;"></div>

                    <button type="submit" class="btn btn-primary" data-label="Concluir Cadastro">Concluir Cadastro</button>
                    <div id="student-error" class="error-message"></div>
                </form>

                <form id="teacher-form" class="form-section">
                    <h2 class="section-title">O que voc√™ pode ensinar?</h2>

                    <div class="add-item-group">
                        <div style="display: grid; gap: 10px;">
                            <input type="text" id="skill-name" placeholder="Ex: Python, Eletricidade, Viol√£o...">
                            <textarea id="skill-description" placeholder="Descreva sua experi√™ncia (opcional)" rows="2"></textarea>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addSkill()">Adicionar</button>
                    </div>

                    <div id="skills-container" style="margin-top: 20px;"></div>

                    <button type="submit" class="btn btn-primary" data-label="Concluir Cadastro">Concluir Cadastro</button>
                    <div id="teacher-error" class="error-message"></div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const origin = window.location.origin;
        const API_BASE = origin && origin !== 'null' ? origin : 'http://localhost:5000';
        const PROFILE_API = `${API_BASE}/api/profile`;

        let selectedUserType = null;
        let interests = [];
        let skills = [];
        let isEditing = false;
        let lockUserType = false;

        function escapeHtml(value) {
            const div = document.createElement('div');
            div.textContent = value ?? '';
            return div.innerHTML;
        }

        function showLoading(show) {
            const loading = document.getElementById('loading-state');
            const content = document.getElementById('form-content');
            loading.style.display = show ? 'block' : 'none';
            content.style.display = show ? 'none' : 'block';
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
            const feedback = document.getElementById('save-feedback');
            feedback.classList.remove('show');
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.textContent = message;
            element.classList.add('show');
        }

        function setPrimaryButtonsLabel(label) {
            document.querySelectorAll('.btn-primary').forEach(btn => {
                btn.dataset.label = label;
                btn.textContent = label;
            });
        }

        function toggleSaving(isSaving) {
            document.querySelectorAll('.btn-primary').forEach(btn => {
                btn.disabled = isSaving;
                btn.textContent = isSaving ? 'Salvando...' : (btn.dataset.label || 'Concluir Cadastro');
            });
        }

        function applyUserTypeUI(type) {
            const studentOption = document.getElementById('student-option');
            const teacherOption = document.getElementById('teacher-option');
            const typeNote = document.getElementById('type-note');

            studentOption.classList.remove('selected', 'disabled');
            teacherOption.classList.remove('selected', 'disabled');

            document.getElementById('student-form').classList.remove('active');
            document.getElementById('teacher-form').classList.remove('active');

            if (type === 'student') {
                studentOption.classList.add('selected');
                document.getElementById('student-form').classList.add('active');
            } else if (type === 'teacher') {
                teacherOption.classList.add('selected');
                document.getElementById('teacher-form').classList.add('active');
            }

            if (lockUserType && type) {
                typeNote.style.display = 'block';
                if (type === 'student') {
                    teacherOption.classList.add('disabled');
                } else {
                    studentOption.classList.add('disabled');
                }
            } else {
                typeNote.style.display = 'none';
            }
        }

        function selectUserType(type) {
            clearErrors();
            if (lockUserType && selectedUserType && type !== selectedUserType) {
                alert('Para alterar o tipo da conta, entre em contato com o suporte.');
                return;
            }
            selectedUserType = type;
            applyUserTypeUI(type);
        }

        function addInterest() {
            clearErrors();
            const name = document.getElementById('interest-name').value.trim();
            const difficulty = document.getElementById('interest-difficulty').value;
            const description = document.getElementById('interest-description').value.trim();

            if (!name) {
                showError('student-error', 'Informe o que deseja aprender antes de adicionar.');
                return;
            }

            interests.push({
                name,
                difficulty,
                description,
                desiredLevel: difficulty
            });
            renderInterests();

            document.getElementById('interest-name').value = '';
            document.getElementById('interest-description').value = '';
        }

        function renderInterests() {
            const container = document.getElementById('interests-container');
            if (interests.length === 0) {
                container.innerHTML = '<p style="color:#666;">Nenhum interesse adicionado ainda.</p>';
                return;
            }

            const label = {
                beginner: 'Iniciante',
                intermediate: 'Intermedi√°rio',
                advanced: 'Avan√ßado'
            };

            container.innerHTML = interests.map((interest, index) => `
                <div class="interest-card">
                    <button class="remove-btn" type="button" onclick="removeInterest(${index})">√ó</button>
                    <strong>${escapeHtml(interest.name)}</strong>
                    <div style="color: #666; font-size: 14px; margin-top: 5px;">
                        N√≠vel desejado: ${label[interest.difficulty] || 'N/A'}
                    </div>
                    ${interest.description ? `<div style="color: #666; font-size: 14px; margin-top: 5px;">${escapeHtml(interest.description)}</div>` : ''}
                </div>
            `).join('');
        }

        function removeInterest(index) {
            interests.splice(index, 1);
            renderInterests();
        }

        function addSkill() {
            clearErrors();
            const name = document.getElementById('skill-name').value.trim();
            const description = document.getElementById('skill-description').value.trim();

            if (!name) {
                showError('teacher-error', 'Informe a habilidade antes de adicionar.');
                return;
            }

            skills.push({
                name,
                description,
                level: null
            });
            renderSkills();

            document.getElementById('skill-name').value = '';
            document.getElementById('skill-description').value = '';
        }

        function renderSkills() {
            const container = document.getElementById('skills-container');
            if (skills.length === 0) {
                container.innerHTML = '<p style="color:#666;">Nenhuma habilidade adicionada ainda.</p>';
                return;
            }

            container.innerHTML = skills.map((skill, index) => `
                <div class="interest-card">
                    <button class="remove-btn" type="button" onclick="removeSkill(${index})">√ó</button>
                    <strong>${escapeHtml(skill.name)}</strong>
                    ${skill.description ? `<div style="color: #666; font-size: 14px; margin-top: 5px;">${escapeHtml(skill.description)}</div>` : ''}
                </div>
            `).join('');
        }

        function removeSkill(index) {
            skills.splice(index, 1);
            renderSkills();
        }

        function collectGeneralFields() {
            const priceRaw = document.getElementById('price-input').value.trim();
            let priceValue = null;

            if (priceRaw !== '') {
                const parsed = parseFloat(priceRaw.replace(',', '.'));
                if (Number.isNaN(parsed)) {
                    throw new Error('invalid-price');
                }
                priceValue = parsed;
            }

            return {
                name: document.getElementById('name-input').value.trim(),
                bio: document.getElementById('bio-input').value.trim(),
                location: document.getElementById('location-input').value.trim(),
                languages: document.getElementById('languages-input').value.trim(),
                availability: document.getElementById('availability-input').value.trim(),
                price_per_hour: priceValue,
                credentials: document.getElementById('credentials-input').value.trim()
            };
        }

        function buildPayload(userType) {
            const payload = collectGeneralFields();

            if (userType === 'teacher') {
                payload.skills = skills.map(skill => ({
                    name: skill.name,
                    description: skill.description || '',
                    level: skill.level || null,
                    requires_evaluation: Boolean(skill.requiresEvaluation)
                }));
            } else if (userType === 'student') {
                payload.interests = interests.map(interest => ({
                    name: interest.name,
                    difficulty: interest.difficulty || 'beginner',
                    description: interest.description || '',
                    desired_level: interest.desiredLevel || interest.difficulty || 'beginner',
                    requires_evaluation: Boolean(interest.requiresEvaluation)
                }));
            }

            return payload;
        }

        async function saveProfile(userType) {
            clearErrors();

            if (!selectedUserType) {
                showError('global-error', 'Selecione se voc√™ quer aprender ou ensinar antes de continuar.');
                return;
            }

            if (selectedUserType !== userType) {
                showError('global-error', 'Finalize o formul√°rio correspondente ao tipo selecionado.');
                return;
            }

            if (userType === 'student' && interests.length === 0) {
                showError('student-error', 'Adicione pelo menos um interesse.');
                return;
            }

            if (userType === 'teacher' && skills.length === 0) {
                showError('teacher-error', 'Adicione pelo menos uma habilidade.');
                return;
            }

            let payload;
            try {
                payload = buildPayload(userType);
            } catch (error) {
                if (error.message === 'invalid-price') {
                    showError('global-error', 'Informe um valor por hora v√°lido usando apenas n√∫meros.');
                    return;
                }
                throw error;
            }

            if (!isEditing) {
                payload.user_type = userType;
            }

            const endpoint = isEditing ? `${PROFILE_API}/update` : `${PROFILE_API}/complete`;
            const method = isEditing ? 'PUT' : 'POST';
            const token = localStorage.getItem('authToken');

            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            toggleSaving(true);

            try {
                const response = await fetch(endpoint, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json().catch(() => ({}));

                if (response.ok) {
                    localStorage.setItem('userType', selectedUserType);
                    const feedback = document.getElementById('save-feedback');
                    feedback.textContent = isEditing ? 'Perfil atualizado com sucesso! Redirecionando...' : 'Perfil completado com sucesso! Vamos te levar aos matches.';
                    feedback.classList.add('show');

                    setTimeout(() => {
                        window.location.href = 'profile.html';
                    }, 1200);
                } else {
                    if (result && result.error) {
                        showError(userType === 'teacher' ? 'teacher-error' : 'student-error', result.error);
                    } else {
                        showError(userType === 'teacher' ? 'teacher-error' : 'student-error', 'N√£o foi poss√≠vel salvar. Tente novamente.');
                    }
                }
            } catch (error) {
                console.error('Erro ao salvar perfil:', error);
                showError(userType === 'teacher' ? 'teacher-error' : 'student-error', 'Erro ao salvar. Verifique sua conex√£o e tente novamente.');
            } finally {
                toggleSaving(false);
            }
        }

        function populateGeneralFields(profile) {
            if (!profile) return;
            document.getElementById('name-input').value = profile.name || '';
            document.getElementById('bio-input').value = profile.bio || '';
            document.getElementById('location-input').value = profile.location || '';
            document.getElementById('languages-input').value = profile.languages || '';
            document.getElementById('availability-input').value = profile.availability || '';
            document.getElementById('credentials-input').value = profile.credentials || '';
            document.getElementById('price-input').value = profile.price_per_hour != null ? profile.price_per_hour : '';
        }

        function populateTypeSpecificData(profile) {
            if (!profile || !profile.user_type) {
                renderInterests();
                renderSkills();
                return;
            }

            if (profile.user_type === 'teacher') {
                skills = Array.isArray(profile.skills) ? profile.skills.map(skill => ({
                    name: skill.skill_name,
                    description: skill.skill_description || '',
                    level: skill.skill_level || null,
                    requiresEvaluation: Boolean(skill.requires_evaluation)
                })) : [];
                renderSkills();
            } else {
                interests = Array.isArray(profile.interests) ? profile.interests.map(interest => ({
                    name: interest.interest_name,
                    difficulty: interest.difficulty_level || 'beginner',
                    description: interest.description || '',
                    desiredLevel: interest.desired_level || interest.difficulty_level || 'beginner',
                    requiresEvaluation: Boolean(interest.requires_evaluation)
                })) : [];
                renderInterests();
            }
        }

        async function loadProfile() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            showLoading(true);

            try {
                const response = await fetch(`${PROFILE_API}/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const profile = await response.json();
                    populateGeneralFields(profile);

                    if (profile.user_type) {
                        isEditing = true;
                        lockUserType = true;
                        selectedUserType = profile.user_type;
                        setPrimaryButtonsLabel('Salvar altera√ß√µes');
                        document.getElementById('page-title').textContent = '‚úèÔ∏è Edite seu Perfil';
                        document.getElementById('page-subtitle').textContent = 'Atualize suas informa√ß√µes para continuar encontrando matches incr√≠veis.';
                    } else {
                        setPrimaryButtonsLabel('Concluir Cadastro');
                    }

                    populateTypeSpecificData(profile);
                    applyUserTypeUI(selectedUserType);
                } else {
                    setPrimaryButtonsLabel('Concluir Cadastro');
                    renderInterests();
                    renderSkills();
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                showError('global-error', 'N√£o foi poss√≠vel carregar suas informa√ß√µes. Tente novamente.');
                renderInterests();
                renderSkills();
            } finally {
                showLoading(false);
            }
        }

        document.getElementById('student-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            await saveProfile('student');
        });

        document.getElementById('teacher-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            await saveProfile('teacher');
        });

        window.addEventListener('DOMContentLoaded', () => {
            if (!localStorage.getItem('authToken')) {
                window.location.href = 'login.html';
            } else {
                loadProfile();
            }
        });
    </script>
</body>
</html>